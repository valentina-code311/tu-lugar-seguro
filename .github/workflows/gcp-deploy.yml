name: Deploy/Destroy to GCP

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "public/**"

permissions:
  contents: read
  id-token: write

env:
  CONN_VARIABLES: |
    [
      {"path":".env", "var":"ENV_FILE"},
      {"path":"front.env", "var":"FRONTEND_ENV_FILE"}
    ]

jobs:
  setup-env:
    name: setup-env
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bootstrap (jq)
        run: sh scripts/startup.sh -t jq

      - name: Create conn/ files from secrets
        shell: bash
        env:
          ENV_FILE: ${{ vars.ENV_FILE }}
          FRONTEND_ENV_FILE: ${{ vars.FRONTEND_ENV_FILE }}
        run: |
          set -euo pipefail

          if [[ -z "${CONN_VARIABLES:-}" ]]; then
            echo "‚ö†Ô∏è CONN_VARIABLES is not defined; nothing to generate."
            exit 0
          fi

          echo "üìù Creating files declared in CONN_VARIABLES"
          mkdir -p conn/

          echo "$CONN_VARIABLES" \
            | jq -r '.[] | "\(.path):\(.var)"' \
            | while IFS=: read -r file varname; do
                if [[ -z "${!varname:-}" ]]; then
                  echo "‚ùå Secret/variable $varname is not defined"
                  exit 1
                fi
                printf '%s' "${!varname}" > "conn/$file"
                echo "   ‚Ä¢ conn/$file ‚Üê $varname"
              done

      - name: Clean CRLF ( \r )
        run: |
          find conn/ -type f -exec sed -i 's/\r//g' {} +

      - name: Upload conn/ artifact
        uses: actions/upload-artifact@v4
        with:
          name: conn
          path: conn/
          retention-days: 1
          include-hidden-files: true

  deploy-frontend-gcp:
    name: deploy-frontend-gcp
    runs-on: ubuntu-latest
    needs: setup-env

    steps:
      - uses: actions/checkout@v4

      - name: Download conn/ artifact
        uses: actions/download-artifact@v4
        with:
          name: conn
          path: conn

      - name: Bootstrap (jq, docker, gcloud)
        run: sh scripts/startup.sh -t jq -t docker -t gcloud

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy frontend
        run: sh scripts/deploy.sh front
